````markdown
# KSP-005: Create Navigator Extensions Generator

## Task Metadata

| Property | Value |
|----------|-------|
| **Task ID** | KSP-005 |
| **Task Name** | Create Navigator Extensions Generator |
| **Phase** | Phase 4: KSP Processor Rewrite |
| **Complexity** | Low |
| **Estimated Time** | 1 day |
| **Dependencies** | KSP-001 (Annotation Extractors) |
| **Blocked By** | KSP-001 |
| **Blocks** | None |

---

## Overview

This task implements the **NavigatorExtGenerator**—an optional code generator that creates convenience extension functions for the `Navigator` class. These extensions provide a more ergonomic API for common navigation actions, reducing boilerplate and improving type safety.

### Purpose

The Navigator Extensions Generator:

1. **Consumes** destination and tab/pane information from KSP-001 extractors
2. **Generates** type-safe extension functions for navigation actions
3. **Creates** convenient `to{Destination}()` methods for each destination
4. **Produces** tab/pane switching helpers for container navigators

### Rationale

While developers can always call `navigator.navigate(SomeDestination.Detail(id))` directly, extension functions provide:

1. **Discoverability**: IDE autocomplete shows all available navigation targets
2. **Conciseness**: `navigator.toDetail(id)` vs `navigator.navigate(HomeDestination.Detail(id))`
3. **Consistency**: Uniform naming convention across the codebase
4. **Refactoring safety**: Changing destination structure updates extensions automatically

---

## Generated Output Location

```
build/generated/ksp/commonMain/kotlin/{package}/generated/
└── NavigatorExtensions.kt
```

---

## Generator Implementation

### NavigatorExtGenerator

```kotlin
package com.jermey.quo.vadis.ksp.generators

import com.google.devtools.ksp.processing.CodeGenerator
import com.google.devtools.ksp.processing.Dependencies
import com.google.devtools.ksp.processing.KSPLogger
import com.jermey.quo.vadis.ksp.models.*
import com.squareup.kotlinpoet.*
import com.squareup.kotlinpoet.ksp.writeTo

/**
 * Generates convenience extension functions for Navigator.
 *
 * This generator creates type-safe navigation helpers that provide
 * a more ergonomic API for common navigation actions.
 */
class NavigatorExtGenerator(
    private val codeGenerator: CodeGenerator,
    private val logger: KSPLogger
) {
    
    companion object {
        private const val GENERATED_PACKAGE_SUFFIX = "generated"
        private const val FILE_NAME = "NavigatorExtensions"
    }
    
    /**
     * Generate all navigator extensions for the given stacks, tabs, and panes.
     *
     * @param stacks List of stack container information
     * @param tabs List of tab container information
     * @param panes List of pane container information
     * @param basePackage Base package for generated file
     */
    fun generate(
        stacks: List<StackInfo>,
        tabs: List<TabInfo>,
        panes: List<PaneInfo>,
        basePackage: String
    ) {
        val packageName = "$basePackage.$GENERATED_PACKAGE_SUFFIX"
        
        val fileSpec = FileSpec.builder(packageName, FILE_NAME)
            .addFileComment("Generated by Quo Vadis KSP - DO NOT EDIT")
            .addFileComment("\nNavigator convenience extensions for type-safe navigation")
            .addImport("com.jermey.quo.vadis.core.navigation.core", "Navigator")
            .apply {
                // Add imports for all destination classes
                stacks.forEach { stack ->
                    addImport(stack.packageName, stack.className)
                }
                tabs.forEach { tab ->
                    addImport(tab.packageName, tab.className)
                }
                panes.forEach { pane ->
                    addImport(pane.packageName, pane.className)
                }
            }
            .apply {
                // Generate extensions for each stack
                stacks.forEach { stack ->
                    addStackExtensions(this, stack)
                }
                
                // Generate tab switching extensions
                tabs.forEach { tab ->
                    addTabSwitchingExtensions(this, tab)
                }
                
                // Generate pane switching extensions
                panes.forEach { pane ->
                    addPaneSwitchingExtensions(this, pane)
                }
            }
            .build()
        
        fileSpec.writeTo(codeGenerator, Dependencies(false))
    }
    
    // =========================================================================
    // Stack Destination Extensions
    // =========================================================================
    
    private fun addStackExtensions(builder: FileSpec.Builder, stack: StackInfo) {
        // Add section comment
        builder.addCode(buildSectionComment("${stack.className} Navigation Extensions"))
        
        stack.destinations.forEach { destination ->
            builder.addFunction(buildDestinationExtension(stack, destination))
        }
    }
    
    private fun buildDestinationExtension(stack: StackInfo, destination: DestinationInfo): FunSpec {
        val functionName = "to${destination.className}"
        val destinationType = ClassName(stack.packageName, stack.className, destination.className)
        
        return if (destination.isDataObject) {
            // Data object - no parameters
            FunSpec.builder(functionName)
                .addKdoc("Navigate to the ${destination.className} screen")
                .receiver(ClassName("com.jermey.quo.vadis.core.navigation.core", "Navigator"))
                .addStatement("navigate(%T)", destinationType)
                .build()
        } else {
            // Data class - parameters required
            val funBuilder = FunSpec.builder(functionName)
                .addKdoc(buildDestinationKDoc(destination))
                .receiver(ClassName("com.jermey.quo.vadis.core.navigation.core", "Navigator"))
            
            // Add parameters from constructor
            destination.constructorParams.forEach { param ->
                val paramSpec = ParameterSpec.builder(
                    param.name,
                    param.type.toTypeName()
                )
                if (param.hasDefault) {
                    // For optional params, we can't easily get defaults, so skip default
                    // Users can use named arguments
                }
                funBuilder.addParameter(paramSpec.build())
            }
            
            // Build destination construction
            val constructorArgs = destination.constructorParams.joinToString(", ") { it.name }
            funBuilder.addStatement("navigate(%T($constructorArgs))", destinationType)
            
            funBuilder.build()
        }
    }
    
    private fun buildDestinationKDoc(destination: DestinationInfo): String {
        val paramDocs = destination.constructorParams.joinToString("\n") { param ->
            "@param ${param.name} ${param.name} parameter for ${destination.className}"
        }
        return """
            |Navigate to the ${destination.className} screen
            |
            $paramDocs
        """.trimMargin()
    }
    
    // =========================================================================
    // Tab Switching Extensions
    // =========================================================================
    
    private fun addTabSwitchingExtensions(builder: FileSpec.Builder, tab: TabInfo) {
        // Add section comment
        builder.addCode(buildSectionComment("${tab.className} Tab Switching Extensions"))
        
        tab.tabs.forEach { tabItem ->
            builder.addFunction(buildTabSwitchExtension(tab, tabItem))
        }
    }
    
    private fun buildTabSwitchExtension(tab: TabInfo, tabItem: TabItemInfo): FunSpec {
        val functionName = "switchTo${tabItem.destination.className}Tab"
        val tabType = ClassName(tab.packageName, tab.className, tabItem.destination.className)
        
        return FunSpec.builder(functionName)
            .addKdoc("Switch to the ${tabItem.label} tab")
            .receiver(ClassName("com.jermey.quo.vadis.core.navigation.core", "Navigator"))
            .addStatement("switchTab(%T)", tabType)
            .build()
    }
    
    // =========================================================================
    // Pane Switching Extensions
    // =========================================================================
    
    private fun addPaneSwitchingExtensions(builder: FileSpec.Builder, pane: PaneInfo) {
        // Add section comment
        builder.addCode(buildSectionComment("${pane.className} Pane Switching Extensions"))
        
        pane.panes.forEach { paneItem ->
            builder.addFunction(buildPaneSwitchExtension(pane, paneItem))
        }
    }
    
    private fun buildPaneSwitchExtension(pane: PaneInfo, paneItem: PaneItemInfo): FunSpec {
        val functionName = "switchTo${paneItem.destination.className}Pane"
        val paneType = ClassName(pane.packageName, pane.className, paneItem.destination.className)
        
        return FunSpec.builder(functionName)
            .addKdoc("Switch to the ${paneItem.destination.className} pane (${paneItem.role.name})")
            .receiver(ClassName("com.jermey.quo.vadis.core.navigation.core", "Navigator"))
            .addStatement("switchPane(%T)", paneType)
            .build()
    }
    
    // =========================================================================
    // Helpers
    // =========================================================================
    
    private fun buildSectionComment(title: String): CodeBlock {
        return CodeBlock.builder()
            .addStatement("")
            .addStatement("// ${"═".repeat(75)}")
            .addStatement("// $title")
            .addStatement("// ${"═".repeat(75)}")
            .addStatement("")
            .build()
    }
    
    /**
     * Convert KSType to KotlinPoet TypeName.
     * Simplified implementation - expand as needed.
     */
    private fun com.google.devtools.ksp.symbol.KSType.toTypeName(): TypeName {
        val declaration = this.declaration
        val qualifiedName = declaration.qualifiedName?.asString() ?: return ANY
        
        return when (qualifiedName) {
            "kotlin.String" -> STRING
            "kotlin.Int" -> INT
            "kotlin.Long" -> LONG
            "kotlin.Boolean" -> BOOLEAN
            "kotlin.Float" -> FLOAT
            "kotlin.Double" -> DOUBLE
            else -> ClassName.bestGuess(qualifiedName)
        }.copy(nullable = this.isMarkedNullable)
    }
}
```

---

## Generated Code Examples

### Input Annotations

```kotlin
@Stack(name = "home", startDestination = "Feed")
sealed class HomeDestination : Destination {
    
    @Destination(route = "home/feed")
    data object Feed : HomeDestination()
    
    @Destination(route = "home/detail/{id}")
    data class Detail(val id: String) : HomeDestination()
    
    @Destination(route = "home/search")
    data class Search(val query: String, val filter: String? = null) : HomeDestination()
}

@Tab(name = "main", initialTab = "Home")
sealed class MainTabs : Destination {
    
    @TabItem(label = "Home", icon = "home", rootGraph = HomeDestination::class)
    @Destination(route = "tab/home")
    data object Home : MainTabs()
    
    @TabItem(label = "Profile", icon = "person", rootGraph = ProfileDestination::class)
    @Destination(route = "tab/profile")
    data object Profile : MainTabs()
}
```

### Output: NavigatorExtensions.kt

```kotlin
// Generated by Quo Vadis KSP - DO NOT EDIT
// Navigator convenience extensions for type-safe navigation
package com.example.generated

import com.jermey.quo.vadis.core.navigation.core.Navigator
import com.example.HomeDestination
import com.example.ProfileDestination
import com.example.MainTabs

// ═══════════════════════════════════════════════════════════════════════════
// HomeDestination Navigation Extensions
// ═══════════════════════════════════════════════════════════════════════════

/** Navigate to the Feed screen */
fun Navigator.toFeed() = navigate(HomeDestination.Feed)

/**
 * Navigate to the Detail screen
 *
 * @param id id parameter for Detail
 */
fun Navigator.toDetail(id: String) = navigate(HomeDestination.Detail(id))

/**
 * Navigate to the Search screen
 *
 * @param query query parameter for Search
 * @param filter filter parameter for Search
 */
fun Navigator.toSearch(query: String, filter: String?) = navigate(HomeDestination.Search(query, filter))

// ═══════════════════════════════════════════════════════════════════════════
// ProfileDestination Navigation Extensions
// ═══════════════════════════════════════════════════════════════════════════

/** Navigate to Profile Overview */
fun Navigator.toProfileOverview() = navigate(ProfileDestination.Overview)

/** Navigate to Settings */
fun Navigator.toSettings() = navigate(ProfileDestination.Settings)

// ═══════════════════════════════════════════════════════════════════════════
// MainTabs Tab Switching Extensions
// ═══════════════════════════════════════════════════════════════════════════

/** Switch to the Home tab */
fun Navigator.switchToHomeTab() = switchTab(MainTabs.Home)

/** Switch to the Profile tab */
fun Navigator.switchToProfileTab() = switchTab(MainTabs.Profile)
```

---

## Usage Examples

### Before (Manual Navigation)

```kotlin
@Composable
fun HomeScreen(navigator: Navigator) {
    Button(onClick = { 
        navigator.navigate(HomeDestination.Detail("item-123"))
    }) {
        Text("View Detail")
    }
    
    Button(onClick = { 
        navigator.switchTab(MainTabs.Profile)
    }) {
        Text("Go to Profile")
    }
}
```

### After (With Extensions)

```kotlin
@Composable
fun HomeScreen(navigator: Navigator) {
    Button(onClick = { 
        navigator.toDetail("item-123")
    }) {
        Text("View Detail")
    }
    
    Button(onClick = { 
        navigator.switchToProfileTab()
    }) {
        Text("Go to Profile")
    }
}
```

---

## Implementation Steps

### Step 1: Set Up Generator Class (2 hours)

Create `NavigatorExtGenerator.kt` with:
- Constructor accepting `CodeGenerator` and `KSPLogger`
- KotlinPoet setup and imports
- Main `generate()` function signature

### Step 2: Implement Destination Extensions (2 hours)

Implement stack destination extensions:
- Handle data objects (no parameters)
- Handle data classes (with constructor parameters)
- Generate proper KDoc for each extension

### Step 3: Implement Tab/Pane Extensions (2 hours)

Implement container switching extensions:
- Tab switching via `switchTab()`
- Pane switching via `switchPane()`
- Include label/role information in KDoc

### Step 4: Integration with Processor (1 hour)

Wire generator into `QuoVadisSymbolProcessor`:
- Optional generation (can be disabled via processor option)
- Aggregate all stacks, tabs, panes before generation
- Single file output for all extensions

### Step 5: Testing (1 hour)

- Verify generated code compiles
- Test extension function signatures
- Verify parameter handling for data classes

---

## Files Affected

| File | Action | Description |
|------|--------|-------------|
| `quo-vadis-ksp/src/main/kotlin/.../generators/NavigatorExtGenerator.kt` | Create | Extension generator class |
| `quo-vadis-ksp/src/main/kotlin/.../QuoVadisSymbolProcessor.kt` | Modify | Wire generator into processing pipeline |

---

## Acceptance Criteria

- [ ] `NavigatorExtGenerator` class implemented with full KDoc
- [ ] `to{Destination}()` extensions generated for all stack destinations
- [ ] Data object destinations generate parameter-less extensions
- [ ] Data class destinations generate extensions with matching parameters
- [ ] `switchTo{Tab}Tab()` extensions generated for all tab items
- [ ] `switchTo{Pane}Pane()` extensions generated for all pane items
- [ ] Generated file placed in `build/generated/ksp/commonMain/kotlin/{package}/generated/`
- [ ] Generated code compiles without errors
- [ ] Section comments clearly separate destination groups
- [ ] KDoc includes parameter documentation
- [ ] Unit tests verify extension generation

---

## Configuration Options

The generator can be configured via KSP processor options:

```kotlin
// In build.gradle.kts
ksp {
    arg("quoVadis.generateNavigatorExtensions", "true")  // Default: true
    arg("quoVadis.extensionsPackage", "com.example.nav") // Override package
}
```

---

## Testing Notes

### Unit Test Examples

```kotlin
class NavigatorExtGeneratorTest {
    
    @Test
    fun `generates extensions for data object destination`() {
        val source = """
            @Stack(name = "test", startDestination = "Home")
            sealed class TestDestination : Destination {
                @Destination(route = "home")
                data object Home : TestDestination()
            }
        """.trimIndent()
        
        val result = compile(source)
        
        assertThat(result.exitCode).isEqualTo(KotlinCompilation.ExitCode.OK)
        
        val generated = result.generatedSourceOf("NavigatorExtensions")
        assertThat(generated).contains("fun Navigator.toHome()")
        assertThat(generated).contains("navigate(TestDestination.Home)")
    }
    
    @Test
    fun `generates extensions with parameters for data class`() {
        val source = """
            @Stack(name = "test", startDestination = "Home")
            sealed class TestDestination : Destination {
                @Destination(route = "detail/{id}")
                data class Detail(val id: String) : TestDestination()
            }
        """.trimIndent()
        
        val result = compile(source)
        
        val generated = result.generatedSourceOf("NavigatorExtensions")
        assertThat(generated).contains("fun Navigator.toDetail(id: String)")
        assertThat(generated).contains("navigate(TestDestination.Detail(id))")
    }
    
    @Test
    fun `generates tab switching extensions`() {
        val source = """
            @Tab(name = "main", initialTab = "Home")
            sealed class MainTabs : Destination {
                @TabItem(label = "Home", icon = "home", rootGraph = HomeDestination::class)
                @Destination(route = "tab/home")
                data object Home : MainTabs()
            }
        """.trimIndent()
        
        val result = compile(source)
        
        val generated = result.generatedSourceOf("NavigatorExtensions")
        assertThat(generated).contains("fun Navigator.switchToHomeTab()")
        assertThat(generated).contains("switchTab(MainTabs.Home)")
    }
}
```

---

## References

- [INDEX.md](../INDEX.md) - Phase 4 KSP Overview
- [KSP-001](./KSP-001-graph-type-enum.md) - Annotation Extractors (prerequisite)
- [CORE-003](../phase1-core/CORE-003-navigator-refactor.md) - Navigator API Reference

````
